<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SavdoGo</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f4f4f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        main {
            flex: 1;
        }
        header {
            background: #fff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .profile-btn,
        .cart-btn,
        .chatbot-btn {
            background: #fff;
            border: none;
            padding: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            touch-action: manipulation;
        }
        .profile-btn:hover,
        .cart-btn:hover,
        .chatbot-btn:hover {
            transform: scale(1.1);
        }
        .profile-btn i,
        .cart-btn i,
        .chatbot-btn i {
            font-size: 24px;
            color: #333;
            transition: color 0.3s;
        }
        .profile-btn:hover i,
        .cart-btn:hover i,
        .chatbot-btn:hover i {
            color: #0057a3;
        }
        .cart-count {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #e91e63;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .search-section {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 15px 20px;
            align-items: center;
            justify-content: flex-start;
            max-width: 1200px;
            margin: 0 auto;
        }
        .search-section input {
            width: 300px;
            padding: 10px;
            border: 1px solid #bbb;
            border-radius: 8px;
            font-size: 16px;
        }
        .catalog-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .catalog-btn:hover {
            background: #0057a3;
        }
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 20px;
        }
        .product {
            display: flex;
            flex-direction: column;
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        .product img {
            width: 100%;
            height: 120px;
            object-fit: contain;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        .product h4 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 5px;
            color: #333;
        }
        .product p {
            font-weight: 700;
            color: #e91e63;
            font-size: 14px;
            margin: 5px 0;
        }
        .product button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            margin-top: auto;
            transition: background 0.3s;
        }
        .product button:hover {
            background: #45a049;
        }
        .quantity-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: auto;
        }
        .quantity-selector button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
        }
        .quantity-selector button:hover {
            background: #45a049;
        }
        .cart-form,
        .profile-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .cart-form.active,
        .profile-form.active {
            display: block;
        }
        .cart-items {
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .cart-form button,
        .profile-form button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
        }
        .cart-form .submit-btn,
        .profile-form .submit-btn {
            background: #4caf50;
            color: white;
        }
        .cart-form .close-btn,
        .profile-form .close-btn {
            background: #dc3545;
            color: white;
        }
        .cart-form input,
        .cart-form select,
        .profile-form input,
        .profile-form select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #bbb;
            border-radius: 6px;
        }
        .cart-form .input-wrap {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .cart-form .input-wrap input {
            padding: 16px;
            font-size: 1.1rem;
            width: 100%;
            border: 2px solid #ccc;
            border-radius: 10px;
        }
        #map {
            height: 300px;
            width: 100%;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .payment-section {
            margin-top: 15px;
        }
        .payment-details {
            display: none;
        }
        .payment-details.active {
            display: block;
        }
        .cart-form label,
        .profile-form label {
            font-weight: 500;
            margin-top: 10px;
            display: block;
        }
        .error-message {
            color: red;
            font-size: 12px;
            display: none;
        }
        .receipt-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1003;
            width: 90%;
            max-width: 400px;
        }
        .receipt-modal.active {
            display: block;
        }
        .chatbot-container {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            height: 470px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1006;
            flex-direction: column;
        }
        .chatbot-container.active {
            display: flex;
        }
        .chatbot-header {
            background: #0057a3;
            color: white;
            padding: 10px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chatbot-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }
        .chatbot-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
            animation: fadeIn 0.3s ease-in;
        }
        .chatbot-message.user {
            background: #e0f7fa;
            margin-left: 20%;
            text-align: right;
            border-right: 4px solid #4caf50;
        }
        .chatbot-message.bot {
            background: #f5f5f5;
            margin-right: 20%;
            border-left: 4px solid #0057a3;
        }
        .chatbot-message img {
            max-width: 150px;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 5px;
        }
        .chatbot-input {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-top: 1px solid #ddd;
        }
        .chatbot-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #bbb;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .chatbot-input button {
            background: #0057a3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #333;
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            z-index: 1001;
        }
        .sidebar a {
            padding: 8px 8px 8px 32px;
            text-decoration: none;
            font-size: 18px;
            color: #f1f1f1;
            display: block;
            transition: 0.3s;
        }
        .sidebar a:hover {
            color: #007bff;
        }
        .sidebar .close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 36px;
            cursor: pointer;
        }
        .sidebar hr {
            border: 0;
            height: 1px;
            background: #f1f1f1;
            margin: 8px 32px;
        }
        .category-content {
            display: none;
        }
        .category-content.active {
            display: block;
        }
        .back-button {
            display: none;
            margin: 15px 20px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .back-button.active {
            display: block;
        }
        footer {
            background: #fff;
            padding: 20px;
            text-align: center;
           
            font-size: 14px;
           
            
        }
        .footer-content {
            color: black;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .footer-logo {
            margin-bottom: 10px;
        }
        .footer-logo h2 {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        .footer-links a {
            font-size: 14px;
            color: #000;
            text-decoration: none;
            transition: color 0.3s;
        }
        .footer-links a:hover {
            color: #0057a3;
        }
        .footer-contact {
            margin: 10px 0;
            font-size: 14px;
        }
        .footer-contact p {
            margin: 5px 0;
        }
        hr {
            margin: 10px;
            margin-bottom: -15px;
            justify-content: center;
            width: 100%;
            max-width: 2000px;
            border: 0;
            height: 1.5px;
            background: #9e9c9c;
        }
        .otasi {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 30px;
        }
        .footer-copyright {
            font-size: 12px;
            color: #666;
        }
        .footerr a {
            font-size: 14px;
            color: black;
            text-decoration: none;
        }
        .footerr a:hover {
            color: #0057a3;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @media (max-width: 600px) {
            .chatbot-container {
                width: 90%;
                height: 80%;
                right: 5%;
                bottom: 10px;
            }
            .header-buttons {
                display: flex;
                justify-content: flex-end;
                align-items: center;
                gap: 8px;
                margin-right: 10px;
                width: 100%;
            }
            .logo {
                font-size: 18px;
                flex-shrink: 0;
            }
            .otasi {
                flex-direction: column;
                gap: 10px;
                align-items: center;
            }
            .footerr {
                margin: 0;
            }
            .footer-links {
                flex-direction: column;
                gap: 10px;
                color: black;
            }
            .footer-content {
                padding: 10px;
            }
            .footer-logo h2 {
                font-size: 20px;
            }
            .footer-contact p {
                font-size: 12px;
            }
            .footer-copyright {
                font-size: 11px;
            }
            .products {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 10px;
            }
            .search-section {
                flex-direction: row;
                gap: 5px;
                justify-content: center;
                padding: 10px 15px;
                flex-wrap: wrap;
            }
            .search-section input {
                width: 100%;
                max-width: 200px;
                font-size: 14px;
            }
            .catalog-btn {
                width: auto;
                padding: 8px 12px;
                font-size: 14px;
            }
            #map {
                height: 250px;
            }
            .profile-btn,
            .cart-btn,
            .chatbot-btn {
                padding: 6px;
            }
            .profile-btn i,
            .cart-btn i,
            .chatbot-btn i {
                font-size: 20px;
            }
            .cart-count {
                width: 16px;
                height: 16px;
                font-size: 10px;
            }
            select {
                font-size: 14px;
                padding: 6px;
            }
        }
        select {
            color: rgb(14, 14, 14);
            border-radius: 10px;
            font-size: 15px;
            padding: 5px;
        }
        .input-wrap {
            margin-bottom: 10px;
        }
        .input-wrap input {
            width: 100%;
            max-width: 300px;
            height: 40px;
            padding: 10px;
        }
        .payment-section {
            background: white;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">SavdoGo</div>
        <div class="header-buttons">
            <select id="languageSelect" onchange="updateLang()">
                <option value="uz">O'zbek</option>
                <option value="ru">Русский</option>
            </select>
            <button onclick="showProfileModal()" class="profile-btn" title="Profil">
                <i class="material-icons">person</i>
            </button>
            <button onclick="showCartModal()" class="cart-btn" title="Savat">
                <i class="material-icons">shopping_cart</i>
                <span class="cart-count" id="cartCount">0</span>
            </button>
            <button onclick="toggleChatbot()" class="chatbot-btn" title="AI Yordamchi">
                <i class="material-icons">chat</i>
            </button>
        </div>
    </header>
    <main>
        <div class="search-section">
            <input type="search" id="searchInput" placeholder="Bir harf kiriting..." oninput="performSearch()">
            <button class="catalog-btn" onclick="openSidebar()">Katalog</button>
        </div>
        <div id="sidebar" class="sidebar">
            <a href="javascript:void(0)" class="close-btn" onclick="closeSidebar()">×</a>
            <div id="mainCategories" class="category-content active">
                <a href="#" onclick="filterByCategory('Tarix')">Tarix</a>
                <hr>
                <a href="#" onclick="filterByCategory('Barchasi')">Barchasi</a>
                <a href="#" onclick="filterByCategory('Avto Ehtiyot Qismlar')">Avto Ehtiyot Qismlar</a>
                <a href="#" onclick="filterByCategory('Kiyimlar')">Kiyimlar</a>
                <a href="#" onclick="filterByCategory('Elektronika')">Elektronika</a>
            </div>
        </div>
        <button id="backButton" class="back-button" onclick="goBackToAllProducts()">Orqaga</button>
        <div id="products" class="products"></div>
        <div class="cart-form" id="cartModal">
            <h3>Savat</h3>
            <div class="cart-items" id="cartItems"></div>
            <p id="totalPrice" style="font-weight: bold; text-align: right;"></p>
            <h4>Mijoz Ma'lumotlari</h4>
            <input type="text" id="firstName" placeholder="Ism" required>
            <input type="text" id="lastName" placeholder="Familiya" required>
            <input type="tel" id="phoneNumber" placeholder="Telefon raqami (+998)" required>
            <div class="input-wrap">
                <input id="address" type="text" placeholder="Tanlangan manzil shu yerga yoziladi" readonly />
            </div>
            <button type="button" onclick="getCurrentLocation()">Joriy Manzil</button>
            <div id="map"></div>
            <div class="payment-section">
                <label>To'lov usuli</label>
                <select id="paymentMethod" onchange="togglePaymentDetails()">
                    <option value="">Tanlang</option>
                    <option value="cash">Naqt</option>
                    <option value="card">Karta</option>
                    <option value="credit">Kredit</option>
                </select>
                <div id="cardDetails" class="payment-details">
                    <input type="text" id="cardNumber" placeholder="Karta raqami (16 raqam)" maxlength="16" required>
                    <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                    <input type="text" id="cardCvv" placeholder="CVV (3 raqam)" maxlength="3" required>
                    <p id="cardError" class="error-message"></p>
                </div>
                <div id="creditDetails" class="payment-details">
                    <input type="text" id="creditFirstName" placeholder="Ism" required>
                    <input type="text" id="creditLastName" placeholder="Familiya" required>
                    <input type="tel" id="creditPhone" placeholder="Telefon raqami (+998)" required>
                    <input type="text" id="passportId" placeholder="Pasport seriyasi yoki ID" required>
                    <input type="number" id="loanDuration" placeholder="Kredit muddati (oy)" min="1" required>
                    <input type="number" id="monthlyIncome" placeholder="Oylik daromad (so'm)" min="0" required>
                    <p id="creditError" class="error-message"></p>
                </div>
            </div>
            <button class="submit-btn" onclick="submitCart()">Tasdiqlash</button>
            <button class="close-btn" onclick="closeCartModal()">Yopish</button>
        </div>
        <div class="profile-form" id="profileModal">
            <h3>Profil</h3>
            <input type="text" id="profileFirstName" placeholder="Ism" required>
            <input type="text" id="profileLastName" placeholder="Familiya" required>
            <input type="tel" id="profilePhoneNumber" placeholder="Telefon raqami (+998)" required>
            <button class="submit-btn" onclick="sendSMSCode()">SMS Kod Yuborish</button>
            <input type="text" id="smsCode" placeholder="5 raqamli SMS kod" maxlength="5" style="display: none;">
            <p id="smsError" class="error-message"></p>
            <button class="submit-btn" id="verifySMSButton" onclick="verifySMSCode()" style="display: none;">Tasdiqlash</button>
            <button class="close-btn" onclick="closeProfileModal()">Yopish</button>
        </div>
        <div class="receipt-modal" id="receiptModal">
            <h3>Buyurtma Cheki</h3>
            <div id="receiptContent"></div>
            <button class="close-btn" onclick="closeReceiptModal()">Yopish</button>
        </div>
        <div class="chatbot-container" id="chatbotContainer">
            <div class="chatbot-header">
                <h3>SavdoGo AI</h3>
                <button onclick="toggleChatbot()">−</button>
            </div>
            <div class="chatbot-messages" id="chatBody"></div>
            <div class="chatbot-input">
                <input type="text" id="chatInput" placeholder="Savol kiriting..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()">Yuborish</button>
            </div>
        </div>
    </main>
    <footer>
        <div class="footer-content">
            <div class="footer-logo"><h2>SavdoGo</h2></div>
            <div class="footer-links">
                <a href="./biz-haqimizda.html">Biz haqimizda</a>
                <a href="./ishga.html">Ishga Qabul</a>
            </divMID
            <div class="footer-contact">
                <p>Telefon: +998 (93) 857-33-11</p>
                <p>Email: SavdoGo@gmail.com</p>
            </div>
        </div>
        </div>
        </footer>
        <hr>
        <div class="otasi">
            <div class="footerr"><a href="./keleshuvlar.html">SavdoGo Bilan Kelishuvlar</a></div>
            <div class="footer-copyright">© 2025 SavdoGo. Barcha huquqlar himoyalangan.</div>
        </div>
    </footer>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const products = [
            { id: 1, name: "Smartfon", price: 1500000, category: "Elektronika", image: "https://via.placeholder.com/150/FF0000", description: "Zamonaviy smartfon, 4G, 128GB xotira.", keywords: ["smartfon", "telefon", "4G", "128GB", "mobil", "uyali"], stock: 10 },
            { id: 2, name: "Limonad", price: 5000, category: "Ichimlik", image: "https://via.placeholder.com/150/00FF00", description: "Sovuq ichimlik, tabiiy limon ta'mi.", keywords: ["limonad", "ichimlik", "sovuq", "limon", "suv", "gazli"], stock: 100 },
            { id: 3, name: "Olma", price: 3000, category: "Meva", image: "https://via.placeholder.com/150/0000FF", description: "Yangi olma, organik.", keywords: ["olma", "meva", "yangi", "organik", "yashil olma", "qizil olma"], stock: 200 },
            { id: 4, name: "Televizor OLED", price: 5000000, category: "Elektronika", image: "https://via.placeholder.com/150/FFFF00", description: "4K OLED televizor, 55 inch smart TV.", keywords: ["televizor", "4K", "OLED", "smart TV", "55 inch", "tv", "tele"], stock: 5 },
            { id: 5, name: "Kostyum", price: 250000, category: "Kiyimlar", image: "https://via.placeholder.com/150/FF00FF", description: "Zamonaviy erkaklar kostyumi.", keywords: ["kostyum", "kiyim", "erkaklar", "moda"], stock: 15 },
            { id: 6, name: "Rul", price: 120000, category: "Avto Ehtiyot Qismlar", image: "https://via.placeholder.com/150/00FFFF", description: "Avtomobil uchun rul.", keywords: ["rul", "avto", "ehtiyot qism"], stock: 8 },
            { id: 7, name: "HR Kitob", price: 50000, category: "HR", image: "https://via.placeholder.com/150/FFA500", description: "HR bo'yicha qo'llanma.", keywords: ["hr", "kitob", "o'quv"], stock: 20 }
        ];

        const fallbackResponses = {
            uz: {
                greeting: "Assalomu Alaykum! SavdoGo platformasida xush kelibsiz. Sizga qanday yordam bera olaman?",
                notFound: "Savolingizni tushunmadim. Iltimos, aniqroq yozing.",
                error: "Texnik xato yuz berdi. Keyinroq urinib ko‘ring.",
                catalog: "Katalogni ko‘rish uchun 'Katalog' tugmasini bosing yoki quyidagi mahsulotlarni ko‘ring:<br>" +
                         products.map(p => `${p.name} - ${p.price.toLocaleString('uz-UZ')} so‘m`).join('<br>'),
                help: "Mavjud komandalar: Smartfonlar, Kredit, Naqt, Manzil, Registratsiya, Profil, Katalog, Platforma haqida, To‘lovlar, Narxlar ro‘yxati, Aksiya, Savat holati, Buyurtma holati, Mahsulot tavsifi, Bog‘lanish, Yetkazib berish muddati, Mahsulot qaytarish, Chegirmalar, Mahsulot mavjudligi, To‘lov holati, Shikoyat, Kategoriyalar, Eng arzon, Savatni tozalash, Ishlash uchun bog‘lanish, Promokod, Mahsulot solishtirish, Sayt foydalanish qo‘llanmasi, Buyurtma bekor qilish, Mahsulot sifati, Yordam."
            },
            ru: {
                greeting: "Здравствуйте! Добро пожаловать на платформу SavdoGo. Чем могу помочь?",
                notFound: "Не понял ваш запрос. Пожалуйста, напишите точнее.",
                error: "Произошла техническая ошибка. Попробуйте позже.",
                catalog: "Для просмотра каталога нажмите кнопку 'Каталог' или ознакомьтесь с товарами:<br>" +
                         products.map(p => `${p.name} - ${p.price.toLocaleString('ru-RU')} сум`).join('<br>'),
                help: "Доступные команды: Смартфоны, Кредит, Наличные, Адрес, Регистрация, Профиль, Каталог, О платформе, Оплаты, Список цен, Акция, Состояние корзины, Статус заказа, Описание товара, Контакты, Срок доставки, Возврат товара, Скидки, Наличие товара, Статус оплаты, Жалоба, Категории, Самый дешевый, Очистить корзину, Связь для работы, Промокод, Сравнение товаров, Руководство по сайту, Отмена заказа, Качество товара, Помощь."
            }
        };

        let cart = [];
        let orderHistory = [];
        let isChatbotOpen = false;
        let greeted = false;
        let chatHistory = [];
        let map, marker;
        let currentCategory = null;
        let generatedSMSCode = null;

        const TASHKENT_BOUNDS = {
            latMin: 41.0,
            latMax: 41.45,
            lonMin: 69.0,
            lonMax: 69.45
        };

        const productsContainer = document.getElementById('products');
        const cartModal = document.getElementById('cartModal');
        const profileModal = document.getElementById('profileModal');
        const cartItems = document.getElementById('cartItems');
        const totalPrice = document.getElementById('totalPrice');
        const cartCount = document.getElementById('cartCount');
        const chatInput = document.getElementById('chatInput');
        const chatBody = document.getElementById('chatBody');
        const receiptModal = document.getElementById('receiptModal');
        const sidebar = document.getElementById('sidebar');
        const backButton = document.getElementById('backButton');

        // Initialize Leaflet Map
        function initMap() {
            map = L.map('map').setView([41.3111, 69.2797], 12); // Toshkent markazi
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: '© OpenStreetMap'
            }).addTo(map);
            map.on('click', async function(e) {
                const lat = e.latlng.lat;
                const lon = e.latlng.lng;

                const inTashkent = (lat > TASHKENT_BOUNDS.latMin && lat < TASHKENT_BOUNDS.latMax && lon > TASHKENT_BOUNDS.lonMin && lon < TASHKENT_BOUNDS.lonMax);
                if (!inTashkent) {
                    const lang = document.getElementById('languageSelect')?.value || 'uz';
                    alert(lang === 'uz' ? "Faqat Toshkent hududi ichida manzil tanlash mumkin!" : "Выберите адрес только в пределах Ташкента!");
                    return;
                }

                if (marker) map.removeLayer(marker);
                marker = L.marker([lat, lon]).addTo(map);

                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                const data = await res.json();

                const address = data.display_name || (lang === 'uz' ? "Manzil topilmadi" : "Адрес не найден");
                document.getElementById('address').value = address;
                marker.bindPopup(address).openPopup();
            });
        }

        // Get Current Location
        function getCurrentLocation() {
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const inTashkent = (lat > TASHKENT_BOUNDS.latMin && lat < TASHKENT_BOUNDS.latMax && lon > TASHKENT_BOUNDS.lonMin && lon < TASHKENT_BOUNDS.lonMax);
                    if (!inTashkent) {
                        alert(lang === 'uz' ? "Joriy manzil Toshkent hududida emas!" : "Текущий адрес находится за пределами Ташкента!");
                        return;
                    }
                    map.setView([lat, lon], 13);
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lon]).addTo(map);
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('address').value = data.display_name || (lang === 'uz' ? 'Manzil aniqlanmadi' : 'Адрес не определен');
                            marker.bindPopup(data.display_name).openPopup();
                        });
                }, () => {
                    alert(lang === 'uz' ? 'Joriy manzilni aniqlash imkonsiz. Iltimos, manzilni xaritada tanlang.' : 'Не удалось определить текущий адрес. Пожалуйста, выберите адрес на карте.');
                });
            } else {
                alert(lang === 'uz' ? 'Brauzeringiz geolokatsiyani qo‘llab-quvvatlamaydi.' : 'Ваш браузер не поддерживает геолокацию.');
            }
        }

        // Profile Modal Functions
        function showProfileModal() {
            if (!profileModal) return console.error('Profile modal not found');
            profileModal.classList.add('active');
            document.getElementById('smsCode').style.display = 'none';
            document.getElementById('verifySMSButton').style.display = 'none';
            document.getElementById('smsError').style.display = 'none';
        }

        function closeProfileModal() {
            if (!profileModal) return console.error('Profile modal not found');
            profileModal.classList.remove('active');
            document.getElementById('profileFirstName').value = '';
            document.getElementById('profileLastName').value = '';
            document.getElementById('profilePhoneNumber').value = '';
            document.getElementById('smsCode').value = '';
            generatedSMSCode = null;
        }

        function sendSMSCode() {
            const firstName = document.getElementById('profileFirstName').value;
            const lastName = document.getElementById('profileLastName').value;
            const phoneNumber = document.getElementById('profilePhoneNumber').value;
            const smsError = document.getElementById('smsError');
            const lang = document.getElementById('languageSelect')?.value || 'uz';

            if (!firstName || !lastName || !phoneNumber) {
                smsError.textContent = lang === 'uz' ? 'Iltimos, barcha maydonlarni to‘ldiring.' : 'Пожалуйста, заполните все поля.';
                smsError.style.display = 'block';
                return;
            }
            if (!/^\+998\d{9}$/.test(phoneNumber)) {
                smsError.textContent = lang === 'uz' ? 'Telefon raqami +998 bilan boshlanishi va 9 raqamdan iborat bo‘lishi kerak.' : 'Номер телефона должен начинаться с +998 и содержать 9 цифр.';
                smsError.style.display = 'block';
                return;
            }

            generatedSMSCode = Math.floor(10000 + Math.random() * 90000).toString();
            alert(`${lang === 'uz' ? 'SMS kod yuborildi: ' : 'SMS-код отправлен: '}${generatedSMSCode}`);
            document.getElementById('smsCode').style.display = 'block';
            document.getElementById('verifySMSButton').style.display = 'block';
            smsError.style.display = 'none';
        }

        function verifySMSCode() {
            const smsCode = document.getElementById('smsCode').value;
            const smsError = document.getElementById('smsError');
            const lang = document.getElementById('languageSelect')?.value || 'uz';

            if (!/^\d{5}$/.test(smsCode)) {
                smsError.textContent = lang === 'uz' ? 'SMS kod 5 raqamdan iborat bo‘lishi kerak.' : 'SMS-код должен состоять из 5 цифр.';
                smsError.style.display = 'block';
                return;
            }
            if (smsCode !== generatedSMSCode) {
                smsError.textContent = lang === 'uz' ? 'Noto‘g‘ri SMS kod.' : 'Неверный SMS-код.';
                smsError.style.display = 'block';
                return;
            }

            smsError.style.display = 'none';
            alert(lang === 'uz' ? 'Profil muvaffaqiyatli tasdiqlandi!' : 'Профиль успешно подтвержден!');
            closeProfileModal();
        }

        // Toggle Payment Details
        function togglePaymentDetails() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            document.getElementById('cardDetails').classList.toggle('active', paymentMethod === 'card');
            document.getElementById('creditDetails').classList.toggle('active', paymentMethod === 'credit');
            if (paymentMethod === 'card') {
                const today = new Date();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = String(today.getFullYear()).slice(-2);
                document.getElementById('cardExpiry').value = `${month}/${year}`;
            } else {
                document.getElementById('cardExpiry').value = '';
            }
        }

        // Validate Cart Inputs
        function validateInputs() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const address = document.getElementById('address').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!firstName || !lastName || !phoneNumber || !address || !paymentMethod) {
                alert('Iltimos, barcha majburiy maydonlarni to‘ldiring.');
                return false;
            }

            if (paymentMethod === 'card') {
                const cardNumber = document.getElementById('cardNumber').value;
                const cardCvv = document.getElementById('cardCvv').value;
                const cardError = document.getElementById('cardError');

                if (!/^\d{16}$/.test(cardNumber)) {
                    cardError.textContent = 'Karta raqami 16 raqamdan iborat bo‘lishi kerak.';
                    cardError.style.display = 'block';
                    return false;
                }
                if (!/^\d{3}$/.test(cardCvv)) {
                    cardError.textContent = 'CVV 3 raqamdan iborat bo‘lishi kerak.';
                    cardError.style.display = 'block';
                    return false;
                }
                cardError.style.display = 'none';
            } else if (paymentMethod === 'credit') {
                const creditFirstName = document.getElementById('creditFirstName').value;
                const creditLastName = document.getElementById('creditLastName').value;
                const creditPhone = document.getElementById('creditPhone').value;
                const passportId = document.getElementById('passportId').value;
                const loanDuration = document.getElementById('loanDuration').value;
                const monthlyIncome = document.getElementById('monthlyIncome').value;
                const creditError = document.getElementById('creditError');

                if (!creditFirstName || !creditLastName || !creditPhone || !passportId || !loanDuration || !monthlyIncome) {
                    creditError.textContent = 'Iltimos, barcha kredit maydonlarini to‘ldiring.';
                    creditError.style.display = 'block';
                    return false;
                }
                if (loanDuration < 1) {
                    creditError.textContent = 'Kredit muddati kamida 1 oy bo‘lishi kerak.';
                    creditError.style.display = 'block';
                    return false;
                }
                if (monthlyIncome < 0) {
                    creditError.textContent = 'Oylik daromad 0 dan kam bo‘lmasligi kerak.';
                    creditError.style.display = 'block';
                    return false;
                }
                creditError.style.display = 'none';
            }
            return true;
        }

        function renderProducts(productList = products) {
            if (!productsContainer) return console.error('Products container not found');
            const fragment = document.createDocumentFragment();
            productList.forEach(product => {
                const quantity = product.quantity || (cart.find(c => c.id === product.id)?.quantity || 0);
                const div = document.createElement('div');
                div.className = 'product';
                div.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <h4>${product.name}${quantity > 0 && product.fromOrder ? ` (x${quantity})` : ''}</h4>
                    <p>${product.price.toLocaleString('uz-UZ')} so'm</p>
                    ${quantity === 0 && !product.fromOrder ? `<button onclick="addToCart(${product.id})"><i class="material-icons">add_shopping_cart</i></button>` : 
                    quantity > 0 && !product.fromOrder ? `
                        <div class="quantity-selector">
                            <button onclick="updateQuantity(${product.id}, -1)">−</button>
                            <span>${quantity}</span>
                            <button onclick="updateQuantity(${product.id}, 1)">+</button>
                        </div>
                    ` : ''}
                `;
                fragment.appendChild(div);
            });
            productsContainer.innerHTML = '';
            productsContainer.appendChild(fragment);
            backButton.classList.toggle('active', currentCategory && currentCategory !== 'Barchasi' && currentCategory !== 'Tarix');
        }

        function addToCart(id) {
            const product = products.find(p => p.id === id);
            if (product && product.stock > 0) {
                updateQuantity(id, 1);
                product.stock -= 1;
            } else {
                const lang = document.getElementById('languageSelect')?.value || 'uz';
                appendChatMessage('bot', lang === 'uz' ? `${product.name} omborda mavjud emas.` : `Товар ${product.name} отсутствует на складе.`);
            }
        }

        function updateQuantity(productId, change) {
            let item = cart.find(c => c.id === productId);
            const product = products.find(p => p.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    cart = cart.filter(c => c.id !== productId);
                    product.stock += 1;
                }
            } else if (change > 0 && product.stock > 0) {
                cart.push({ id: productId, name: product.name, price: product.price, quantity: 1 });
                product.stock -= 1;
            }
            updateCart();
            renderProducts(currentCategory ? (currentCategory === 'Tarix' ? orderHistory.flatMap(order => 
                order.items.map(item => ({
                    ...item,
                    fromOrder: true,
                    id: `${item.name}-${order.date}`,
                    category: 'Tarix'
                }))
            ) : currentCategory === 'Barchasi' ? products : products.filter(p => p.category === currentCategory)) : products);
            if (cartCount) cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
        }

        function updateCart() {
            if (!cartItems || !totalPrice) return console.error('Cart elements not found');
            const fragment = document.createDocumentFragment();
            let total = 0;
            cart.forEach(item => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <span>${item.name} x ${item.quantity}</span>
                    <span>${(item.price * item.quantity).toLocaleString('uz-UZ')} so‘m</span>
                `;
                fragment.appendChild(div);
                total += item.price * item.quantity;
            });
            cartItems.innerHTML = '';
            cartItems.appendChild(fragment);
            totalPrice.textContent = `Jami: ${total.toLocaleString('uz-UZ')} so‘m`;
        }

        function showCartModal() {
            if (!cartModal) return console.error('Cart modal not found');
            updateCart();
            cartModal.classList.add('active');
            initMap();
        }

        function closeCartModal() {
            if (!cartModal) return console.error('Cart modal not found');
            cartModal.classList.remove('active');
        }

        function submitCart() {
            if (!cart.length) {
                alert('Savat bo‘sh!');
                return;
            }
            if (!validateInputs()) return;

            const receiptContent = document.getElementById('receiptContent');
            if (!receiptContent) return console.error('Receipt content not found');

            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const phoneNumber = document.getElementById('phoneNumber').value;
            const address = document.getElementById('address').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const deliveryTime = Math.floor(Math.random() * (60 - 15 + 1)) + 15;

            const order = {
                items: cart.map(item => ({
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    image: products.find(p => p.id === item.id)?.image || "https://via.placeholder.com/150"
                })),
                total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                date: new Date().toLocaleString('uz-UZ'),
                customer: { firstName, lastName, phoneNumber, address },
                paymentMethod,
                deliveryTime
            };
            orderHistory.push(order);

            receiptContent.innerHTML = `
                <p><strong>Mijoz:</strong> ${order.customer.firstName} ${order.customer.lastName}</p>
                <p><strong>Telefon:</strong> ${order.customer.phoneNumber}</p>
                <p><strong>Manzil:</strong> ${order.customer.address}</p>
                <p><strong>Buyurtma:</strong> ${order.items.map(item => `${item.name} x ${item.quantity}`).join(', ')}</p>
                <p><strong>Jami:</strong> ${order.total.toLocaleString('uz-UZ')} so‘m</p>
                <p><strong>Sana:</strong> ${order.date}</p>
                <p><strong>Yetkazib berish vaqti:</strong> Taxminan ${order.deliveryTime} minut</p>
                <p><strong>To'lov usuli:</strong> ${order.paymentMethod === 'cash' ? 'Naqt' : order.paymentMethod === 'card' ? 'Karta' : 'Kredit'}</p>
            `;
            cartModal.classList.remove('active');
            receiptModal.classList.add('active');
            cart = [];
            updateCart();
            renderProducts();
            if (cartCount) cartCount.textContent = '0';
        }

        function closeReceiptModal() {
            if (!receiptModal) return console.error('Receipt modal not found');
            receiptModal.classList.remove('active');
        }

        function openSidebar() {
            sidebar.style.width = "250px";
            showMainCategories();
            document.addEventListener('click', outsideClickListener);
        }

        function closeSidebar() {
            sidebar.style.width = "0";
            document.removeEventListener('click', outsideClickListener);
        }

        function outsideClickListener(event) {
            if (!sidebar.contains(event.target) && !document.querySelector('.catalog-btn').contains(event.target)) {
                closeSidebar();
            }
        }

        function showMainCategories() {
            document.querySelectorAll('.category-content').forEach(content => content.classList.remove('active'));
            document.getElementById('mainCategories').classList.add('active');
        }

        function filterByCategory(category) {
            currentCategory = category;
            let filteredProducts = [];
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            
            if (category === 'Tarix') {
                filteredProducts = orderHistory.flatMap(order => 
                    order.items.map(item => ({
                        ...item,
                        fromOrder: true,
                        id: `${item.name}-${order.date}`,
                        category: 'Tarix'
                    }))
                );
                message = orderHistory.length > 0 ?
                    `${lang === 'uz' ? 'Buyurtma tarixi:' : 'История заказов:'}<br>` +
                    orderHistory.map((order, index) => 
                        `${lang === 'uz' ? `Buyurtma #${index + 1}` : `Заказ #${index + 1}`}: ` +
                        `${order.items.map(item => `${item.name} x ${item.quantity} - ${(item.price * item.quantity).toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m`).join(', ')}<br>` +
                        `${lang === 'uz' ? 'Jami' : 'Итого'}: ${order.total.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m<br>` +
                        `${lang === 'uz' ? 'Sana' : 'Дата'}: ${order.date}`
                    ).join('<br><br>') :
                    lang === 'uz' ? 'Hozircha buyurtmalar yo‘q.' : 'Пока заказов нет.';
            } else {
                filteredProducts = category === 'Barchasi' ? products : products.filter(p => p.category === category);
                message = filteredProducts.length > 0 ?
                    `${lang === 'uz' ? 'Kategoriya bo‘yicha mahsulotlar' : 'Товары по категории'}: ${filteredProducts.map(p => p.name).join(', ')}` :
                    lang === 'uz' ? 'Bu kategoriyada mahsulotlar topilmadi.' : 'В этой категории товары не найдены.';
            }
            
            renderProducts(filteredProducts);
            closeSidebar();
            appendChatMessage('bot', message);
        }

        function goBackToAllProducts() {
            currentCategory = null;
            renderProducts();
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            appendChatMessage('bot', lang === 'uz' ? 'Barcha mahsulotlar ro‘yxatiga qaytildi.' : 'Вернулись к списку всех товаров.');
        }

        function toggleChatbot() {
            isChatbotOpen = !isChatbotOpen;
            const chatbotContainer = document.getElementById('chatbotContainer');
            if (!chatbotContainer) return console.error('Chatbot container not found');
            chatbotContainer.classList.toggle('active', isChatbotOpen);
            document.querySelector('.chatbot-header button').textContent = isChatbotOpen ? '−' : '+';
            if (isChatbotOpen && !greeted) {
                greeted = true;
                appendChatMessage('bot', fallbackResponses[document.getElementById('languageSelect')?.value || 'uz'].greeting);
            }
        }

        function sendChatMessage() {
            if (!chatInput || !chatBody) return console.error('Chat input or body not found');
            const message = chatInput.value.trim();
            if (!message) {
                appendChatMessage('bot', fallbackResponses[document.getElementById('languageSelect')?.value || 'uz'].notFound);
                return;
            }
            appendChatMessage('user', message);
            chatHistory.push({ role: 'user', content: message });
            getBotResponse(message).then(response => {
                appendChatMessage('bot', response);
                chatHistory.push({ role: 'bot', content: response });
                chatInput.value = '';
            }).catch(() => appendChatMessage('bot', fallbackResponses[document.getElementById('languageSelect')?.value || 'uz'].error));
        }

        function appendChatMessage(type, message) {
            if (!chatBody) return console.error('Chat body not found');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chatbot-message ${type}`;
            messageDiv.innerHTML = message;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function clearCart() {
            cart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) product.stock += item.quantity;
            });
            cart = [];
            updateCart();
            renderProducts();
            if (cartCount) cartCount.textContent = '0';
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            appendChatMessage('bot', lang === 'uz' ? 'Savat tozalandi.' : 'Корзина очищена.');
        }

        async function getBotResponse(message) {
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            const currentDateTime = new Date().toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU', { timeZone: 'Asia/Tashkent' });

            if (!message || message.trim().length === 0) {
                return `${fallbackResponses[lang].notFound} ${currentDateTime}`;
            }

            const quickReplyResponses = {
                Smartfonlar: products
                    .filter(p => p.category === 'Elektronika')
                    .map(p => `${p.name} - ${p.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m (${p.description})`)
                    .join('<br>'),
                Kredit: lang === 'uz'
                    ? 'Kredit olish uchun onlayn ariza to‘ldiring, pasport va daromad ma’lumotlarini kiriting.'
                    : 'Для получения кредита заполните онлайн-заявку, указав паспорт и данные о доходах.',
                Naqt: lang === 'uz'
                    ? 'Naqt to‘lov yetkazib berish vaqtida amalga oshiriladi.'
                    : 'Оплата наличными производится при доставке.',
                Manzil: lang === 'uz'
                    ? 'Manzilni shaxsiy kabinetda shahar, ko‘cha va uy raqami kiritib qo‘shing.'
                    : 'Добавьте адрес в личном кабинете, указав город, улицу и номер дома.',
                Registratsiya: lang === 'uz'
                    ? 'Telefon raqami orqali ro‘yxatdan o‘ting, SMS kod bilan tasdiqlang, ism, familiya va email kiriting.'
                    : 'Зарегистрируйтесь по номеру телефона, подтвердите кодом из SMS, укажите имя, фамилию и email.',
                Profil: lang === 'uz'
                    ? 'Profilni sozlash uchun ism, familiya va telefon raqamini kiriting, so‘ng SMS kodni tasdiqlang.'
                    : 'Для настройки профиля введите имя, фамилию и номер телефона, затем подтвердите SMS-код.',
                Katalog: fallbackResponses[lang].catalog,
                'Platforma haqida': lang === 'uz'
                    ? 'SavdoGo - 2025-yilda tashkil topgan onlayn savdo platformasi bo‘lib, turli mahsulotlar va qulay xizmatlar taqdim etadi.'
                    : 'SavdoGo - онлайн-платформа для торговли, основанная в 2025 году, предлагает различные товары и удобные услуги.',
                'To‘lovlar': lang === 'uz'
                    ? 'To‘lov turlari: naqd, karta (Visa, Mastercard), kredit.'
                    : 'Способы оплаты: наличные, карта (Visa, Mastercard), кредит.',
                'Narxlar ro‘yxati': products
                    .map(p => `${p.name}: ${p.price.toLocaleString(lang === 'uz' ? 'uz-UZ' : 'ru-RU')} so‘m`)
                    .join('<br>'),
                Aksiya: lang === 'uz'
                    ? 'Hozirda Smartfon uchun 10% chegirma mavjud (30/06/2025 gacha).'
                    : 'Сейчас действует скидка 10% на смартфон (до 30/06/2025).',
                'Savat holati': cart.length > 0
                    ? `${lang === 'uz' ? 'Savatdagi mahsulotlar' : 'Товары в корзине'}: ${cart.map(item => `${item.name} x ${item.quantity}`).join(', ')}`
                    : lang === 'uz' ? 'Savat bo‘sh.' : 'Корзина пуста.',
                'Buyurtma holati': orderHistory.length > 0
                    ? orderHistory.map((order, index) => 
                        `${lang === 'uz' ? `Buyurtma #${index + 1}` : `Заказ #${index + 1}`}: ${order.items.map(item => `${item.name} x ${item.quantity}`).join(', ')}`
                      ).join('<br>')
                    : lang === 'uz' ? 'Hozircha buyurtmalar yo‘q.' : 'Пока заказов нет.',
                'Mahsulot tavsifi': lang === 'uz'
                    ? 'Mahsulot nomini kiriting (masalan, "Smartfon").'
                    : 'Введите название товара (например, "Смартфон").',
                'Bog‘lanish': lang === 'uz'
                    ? 'Telefon: +998 (93) 857-33-11, Email: support@savdogo.com.'
                    : 'Телефон: +998 (93) 857-33-11, Email: support@savdogo.com.',
                'Yetkazib berish muddati': lang === 'uz'
                    ? 'Toshkent ichida 1-2 kun, viloyatlarga 3-5 kun.'
                    : 'По Ташкенту 1-2 дня, в регионы 3-5 дней.',
                'Mahsulot qaytarish': lang === 'uz'
                    ? 'Mahsulotni 14 kun ichida qaytarish mumkin.'
                    : 'Возврат товара возможен в течение 14 дней.',
                Chegirmalar: lang === 'uz'
                    ? 'Smartfon uchun 10% chegirma mavjud.'
                    : 'Скидка 10% на смартфон.',
                'Mahsulot mavjudligi': lang === 'uz'
                    ? 'Mahsulot nomini kiriting.'
                    : 'Введите название товара.',
                'To‘lov holati': lang === 'uz'
                    ? 'To‘lov holatini shaxsiy kabinetda tekshirish.'
                    : 'Проверить статус оплаты в личном кабинете.',
                Shikoyat: lang === 'uz'
                    ? 'Shikoyat uchun support@savdogo.com ga yozing.'
                    : 'Для жалоб пишите на support@savdogo.com.',
                    Salom: lang === 'uz'
                    ? 'Assalomu Alaykum! SavdoGo Platformasiga Xush Kelibsiz! Qanday Yordam Beroliman?'
                    : 'Для жалоб пишите на support@savdogo.com.',
                     Yordam: lang === 'uz' 
               ? 'Sizga Qanday Yordam Bera Olam'
               :'asdadad',
                    Qalesan: lang === 'uz'
                    ?'Assalomu Alaykum! SavdoGo Platformasiga Xush Kelibsiz! Qanday Yordam Beroliman'
                    :'Assalomu Alaykum! SavdoGo Platformasiga Xush Kelibsiz! Qanday Yordam Beroliman',
                Kategoriyalar: [...new Set(products.map(p => p.category))].join(', '),
                'Eng arzon': products.reduce((prev, curr) => prev.price < curr.price ? prev : curr).name,
                'Savatni tozalash': lang === 'uz' ? 'Savat tozalandi.' : 'Корзина очищена.',
                'Ishlash uchun bog‘lanish': lang === 'uz' ? 'hr@savdogo.com' : 'hr@savdogo.com',
                Promokod: lang === 'uz' ? 'Promokod kiritish.' : 'Ввести промокод.',
                'Mahsulot solishtirish': lang === 'uz' ? 'Ikkita mahsulot nomini kiriting.' : 'Введите названия двух товаров.',
                'Sayt foydalanish qo‘llanmasi': lang === 'uz' ? 'Qo‘llanma shaxsiy kabinetda.' : 'Руководство в личном кабинете.',
                'Buyurtma bekor qilish': lang === 'uz' ? 'support@savdogo.com ga yozing.' : 'Пишите на support@savdogo.com.',
                'Mahsulot sifati': lang === 'uz' ? 'Sifat sertifikatlari mavjud.' : 'Имеются сертификаты качества.',
              
            };

            const quickReply = Object.keys(quickReplyResponses).find(key => message.toLowerCase().includes(key.toLowerCase()));
            if (quickReply) {
                return quickReplyResponses[quickReply];
            }
            return fallbackResponses[lang].notFound;
        }

        function performSearch() {
            const searchInput = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            
            const filteredProducts = searchInput.length === 1 ? 
                products.filter(p => p.name.toLowerCase().startsWith(searchInput)) : 
                [];
            
            currentCategory = null;
            renderProducts(filteredProducts);
            
            const searchMessage = filteredProducts.length > 0 ?
                `${lang === 'uz' ? `${searchInput.toUpperCase()} harfi bilan boshlanadigan mahsulotlar:` : `Товары, начинающиеся на ${searchInput.toUpperCase()}:`} ${filteredProducts.map(p => p.name).join(', ')}` :
                lang === 'uz' ? `${searchInput.toUpperCase()} harfi bilan boshlanadigan mahsulotlar topilmadi.` : `Товары, начинающиеся на ${searchInput.toUpperCase()}, не найдены.`;
            appendChatMessage('bot', searchMessage);
        }

        function updateLang() {
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            renderProducts(currentCategory ? (currentCategory === 'Tarix' ? orderHistory.flatMap(order => 
                order.items.map(item => ({
                    ...item,
                    fromOrder: true,
                    id: `${item.name}-${order.date}`,
                    category: 'Tarix'
                }))
            ) : currentCategory === 'Barchasi' ? products : products.filter(p => p.category === currentCategory)) : products);
            updateCart();
            if (isChatbotOpen && !greeted) {
                greeted = true;
                appendChatMessage('bot', fallbackResponses[lang].greeting);
            }
        }

        // Ensure buttons are clickable on touch devices
        document.querySelectorAll('.profile-btn, .cart-btn, .chatbot-btn, .catalog-btn').forEach(button => {
            button.addEventListener('touchstart', function(e) {
                e.preventDefault();
                this.click();
            });
        });
        // Initialize Leaflet Map
function initMap() {
    if (map) {
        map.remove(); // Remove existing map to prevent duplication
    }
    map = L.map('map').setView([41.3111, 69.2797], 12); // Toshkent markazi
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap'
    }).addTo(map);

    // Resize map on window resize for responsive view
    window.addEventListener('resize', () => {
        map.invalidateSize();
    });

    map.on('click', async function(e) {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        const inTashkent = (lat > TASHKENT_BOUNDS.latMin && lat < TASHKENT_BOUNDS.latMax && 
                           lon > TASHKENT_BOUNDS.lonMin && lon < TASHKENT_BOUNDS.lonMax);
        if (!inTashkent) {
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            alert(lang === 'uz' ? "Faqat Toshkent hududi ichida manzil tanlash mumkin!" : 
                  "Выберите адрес только в пределах Ташкента!");
            return;
        }

        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon]).addTo(map);

        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const data = await res.json();
            const address = data.display_name || (lang === 'uz' ? "Manzil topilmadi" : "Адрес не найден");
            document.getElementById('address').value = address;
            marker.bindPopup(address).openPopup();
        } catch (error) {
            console.error('Geocoding error:', error);
            const lang = document.getElementById('languageSelect')?.value || 'uz';
            alert(lang === 'uz' ? "Manzilni aniqlashda xato yuz berdi!" : 
                  "Ошибка при определении адреса!");
        }
    });

    // Ensure map is properly sized after initialization
    setTimeout(() => map.invalidateSize(), 100);
}

// Get Current Location
function getCurrentLocation() {
    const lang = document.getElementById('languageSelect')?.value || 'uz';
    if (!navigator.geolocation) {
        alert(lang === 'uz' ? 'Brauzeringiz geolokatsiyani qo‘llab-quvvatlamaydi.' : 
              'Ваш браузер не поддерживает геолокацию.');
        return;
    }

    navigator.geolocation.getCurrentPosition(
        position => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const inTashkent = (lat > TASHKENT_BOUNDS.latMin && lat < TASHKENT_BOUNDS.latMax && 
                               lon > TASHKENT_BOUNDS.lonMin && lon < TASHKENT_BOUNDS.lonMax);
            if (!inTashkent) {
                alert(lang === 'uz' ? "Joriy manzil Toshkent hududida emas!" : 
                      "Текущий адрес находится за пределами Ташкента!");
                return;
            }

            map.setView([lat, lon], 13);
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);

            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name || (lang === 'uz' ? 'Manzil aniqlanmadi' : 
                                                         'Адрес не определен');
                    document.getElementById('address').value = address;
                    marker.bindPopup(address).openPopup();
                    map.invalidateSize(); // Ensure map is properly rendered
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    alert(lang === 'uz' ? "Manzilni aniqlashda xato yuz berdi!" : 
                          "Ошибка при определении адреса!");
                });
        },
        error => {
            let errorMessage;
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = lang === 'uz' ? 'Geolokatsiyaga ruxsat berilmadi. Iltimos, brauzer sozlamalarida ruxsat bering.' : 
                                   'Доступ к геолокации запрещен. Пожалуйста, разрешите доступ в настройках браузера.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = lang === 'uz' ? 'Joriy manzilni aniqlash imkonsiz.' : 
                                   'Текущий адрес недоступен.';
                    break;
                case error.TIMEOUT:
                    errorMessage = lang === 'uz' ? 'Manzilni aniqlash vaqti tugadi.' : 
                                   'Время ожидания определения адреса истекло.';
                    break;
                default:
                    errorMessage = lang === 'uz' ? 'Geolokatsiyada noma’lum xato yuz berdi.' : 
                                   'Произошла неизвестная ошибка геолокации.';
            }
            alert(errorMessage + (lang === 'uz' ? ' Iltimos, manzilni xaritada tanlang.' : 
                                  ' Пожалуйста, выберите адрес на карте.'));
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

// Update showCartModal to ensure map initialization
function showCartModal() {
    if (!cartModal) return console.error('Cart modal not found');
    updateCart();
    cartModal.classList.add('active');
    initMap(); // Initialize map when cart modal is opened
}

// Add touch event for the "Joriy Manzil" button
document.addEventListener('DOMContentLoaded', () => {
    const locationButton = document.querySelector('button[onclick="getCurrentLocation()"]');
    if (locationButton) {
        locationButton.addEventListener('touchstart', function(e) {
            e.preventDefault();
            getCurrentLocation();
        });
    }
});

        renderProducts();
    </script>
</body>
</html>